<!DOCTYPE html>
<html>
	<head>
		<title>Skills Survey: User CRUD</title>
		<link rel="stylesheet" href="surveyCSS" />
		<script src="tagJS"></script>
		<script src="databaseListsJS"></script>
		<script>
			let gotoSurvey = function(){	location.href = "surveyHTML"	}

			let makeUserForm = function( pParentId ){
				tag('button', pParentId, 'Go to Survey', {
					style:" width: 33%;", 
					class:"menuButton", 
					onclick:"gotoSurvey();"
				})
				tag('button', pParentId, 'Update Users from Harvest',{
					style:" width: 33%;", 
					class:"menuButton",
                    onclick:"getUsersFromAPI();"
				})
				
				getUsersFromDatabase()
                makeUserCrudForm( pParentId )
			}

			let getUsersFromDatabase = function(){
			}

            let cl = console.log

            let getMaxDataWidth = function(){
                let maxRecLength = 0;
                let hdrLength = 0;
                for( let idx in dbResults.user ){
                    let recLength = 0;
                    hdrLength = 0;
                    for( let rec in dbResults.user[ idx ] ){
                        cl( idx + ":" + rec + ": " + dbResults.user[ idx ][ rec ].length + "  " + dbResults.user[ idx ][ rec ] )
                        recLength += dbResults.user[ idx ][ rec ].length 
                        hdrLength += rec.length
                    }
                    if( recLength > maxRecLength ) maxRecLength = recLength
                }
                cl("MaxRecLength: " + maxRecLength );
                cl("HdrLength    : " + hdrLength );
                return {'MaxRecLength':maxRecLength, 'HdrLength':hdrLength}
            }

            let setScreenWidth = function ( pWidths ){}

            let makeUserCrudForm = function( pParentId ){
                // mae a table w/ columns per data.  if too big, set page width > 100%
                // find max record width
                let widths = getMaxDataWidth();
                setScreenWidth( widths )

                let tableId = tag('table', pParentId, '', {} )
                let tableHdrRowId = tag('tr', tableId, '', {} )
                for( let hdr in dbResults.user[ 0 ] ){
                    tag('th', tableHdrRowId, hdr, {} )
                }
                tag('th', tableHdrRowId, 'menu', {} )

                let row = []
                for( let rowIdx in  dbResults.user ){
                    row[ rowIdx ] = tag('tr', tableId, '', {} )
                    for( let hdr in dbResults.user[ rowIdx ] ){
                        let t = tag('td', row[ rowIdx ], '', {} )//dbResults.user[ rowIdx ][ hdr ], {} )
                        cl("switch on " + hdr )
                        let inputType = 'text';
                        switch( dbResults.user_type_map[hdr] ){
                            case 'tinyint(1)':  inputType = 'checkbox'; break;
                            default:            inputtype = 'text';     break;
                        }
                        let i = tag('input', t,'', { type: inputType })
                        document.getElementById( i ).value = dbResults.user[ rowIdx ][ hdr ] 
                    }
					let t = tag('td', row[ rowIdx ], '', {} )
					tag('a', t, '...',{href:'www.google.com'})
                }
            }



            //API
            async function getUsersFromAPI() {
                var headers = {
                    "User-Agent": "Node.js Harvest API Sample",
                    "Authorization": "Bearer "+ document.getElementById( 'token' ).value,
                    "Harvest-Account-ID": document.getElementById( 'accountId' ).value 
                };
                var options = {
                    "method": "get",
                    "headers": headers
                };

                let url ="https://api.harvestapp.com/v2/reports/time/team?from=20220101&to=20230101"
                let myObject = await fetch( url, options );
                let myText = await myObject.text();
                console.log( typeof myText )
                console.log( myText )

                let parsedText = JSON.parse( myText )
                console.log( typeof parsedText )
                console.log( parsedText )
            }

		</script>
	</head>

	<body id='1'>
        <label for="accountId">AccountID:</label>
        <input type="text" id="accountId" name="accountId">
        <label for="token">Token:</label>
        <input type="text" id="token" name="token"><br>

		<script>
			makeUserForm( document.body.id )
		</script>
	</body>
</html>